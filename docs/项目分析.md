# JMComic-Crawler-Python 项目分析文档

## 项目概述

**JMComic-Crawler-Python** 是一个用于访问和下载禁漫天堂（JMComic）内容的Python API框架。项目提供了完整的Python接口，支持网页端和移动端两种客户端实现，可以方便地下载、搜索、管理禁漫内容。

### 项目基本信息

- **项目名称**: JMComic-Crawler-Python
- **当前版本**: v2.6.10
- **Python版本要求**: >= 3.7（建议3.9+）
- **许可证**: MIT License
- **项目状态**: 维护阶段，核心功能稳定
- **GitHub仓库**: https://github.com/hect0x7/JMComic-Crawler-Python

## 核心功能

### 1. 下载功能（核心）

- **本子下载**: 支持下载整个本子（Album）及其所有章节
- **章节下载**: 支持单独下载指定章节（Photo）
- **图片下载与解码**: 自动下载并解密禁漫的加密图片
- **批量下载**: 支持同时下载多个本子或章节
- **多线程下载**: 可细化到一图一线程，下载效率极高

### 2. 数据获取功能

- **本子详情**: 获取本子的完整信息（标题、作者、标签、描述等）
- **章节详情**: 获取章节的图片列表和相关信息
- **搜索功能**: 支持多种搜索方式
  - 站内搜索
  - 作品搜索
  - 作者搜索
  - 标签搜索
  - 登场角色搜索
  - 支持包含/排除搜索语法（+关键词、-关键词）
- **分类浏览**: 支持按分类、时间、排序方式浏览本子
- **排行榜**: 支持日/周/月排行榜
- **收藏夹管理**: 获取、添加收藏夹内容

### 3. 用户功能

- **登录**: 支持账号登录
- **评论**: 支持对本子/章节进行评论
- **收藏**: 支持将本子添加到收藏夹

### 4. 技术特性

- **绕过Cloudflare反爬虫**: 实现了Cloudflare的绕过机制
- **APP接口加解密**: 实现了禁漫APP接口最新的加解密算法（1.6.3版本）
- **自动重试机制**: 支持请求失败自动重试
- **域名切换**: 支持多个域名自动切换
- **缓存机制**: 支持磁盘缓存和内存缓存

## 项目架构

### 模块依赖关系

```
config <--- entity <--- toolkit <--- client <--- option <--- downloader
```

### 核心模块说明

#### 1. `api.py` - API接口层
提供用户友好的API接口：
- `download_album()`: 下载本子
- `download_photo()`: 下载章节
- `download_batch()`: 批量下载
- `create_option_by_file()`: 从配置文件创建选项
- `create_option_by_env()`: 从环境变量创建选项

#### 2. `jm_client_interface.py` - 客户端接口定义
定义了客户端需要实现的所有接口：
- `JmDetailClient`: 获取本子/章节详情
- `JmUserClient`: 用户相关操作（登录、收藏、评论）
- `JmImageClient`: 图片下载相关
- `JmSearchAlbumClient`: 搜索功能
- `JmCategoryClient`: 分类浏览功能
- `JmcomicClient`: 综合客户端接口（继承上述所有接口）

#### 3. `jm_client_impl.py` - 客户端实现
实现了两种客户端：
- `JmHtmlClient`: 网页端客户端实现
  - 通过解析HTML获取数据
  - 效率高，但可能受IP地区限制
- `JmApiClient`: 移动端客户端实现
  - 通过API接口获取数据
  - 需要加解密处理
  - 兼容性好，不限IP地区

#### 4. `jm_downloader.py` - 下载器
负责下载任务的调度和执行：
- `JmDownloader`: 核心下载器类
  - 管理下载流程（本子→章节→图片）
  - 处理下载回调
  - 记录下载成功/失败
- `DownloadCallback`: 下载回调基类
  - `before_album/after_album`: 本子下载前后
  - `before_photo/after_photo`: 章节下载前后
  - `before_image/after_image`: 图片下载前后

#### 5. `jm_option.py` - 配置选项
管理所有配置项：
- `JmOption`: 配置选项类
  - 客户端配置（域名、实现方式、代理等）
  - 下载配置（线程数、重试次数、图片格式等）
  - 路径规则配置
  - 插件配置
- `DirRule`: 下载路径规则
  - 支持DSL规则定义下载路径
  - 支持繁简体转换

#### 6. `jm_entity.py` - 实体类
定义了数据实体：
- `JmAlbumDetail`: 本子详情
- `JmPhotoDetail`: 章节详情
- `JmImageDetail`: 图片详情
- `JmSearchPage`: 搜索结果页
- `JmCategoryPage`: 分类页
- `JmFavoritePage`: 收藏夹页

#### 7. `jm_plugin.py` - 插件系统
提供了可扩展的插件机制：
- `JmOptionPlugin`: 插件基类
- 内置插件包括：
  - 登录插件
  - 硬件占用监控插件
  - 只下载新章插件
  - 压缩文件插件
  - 下载特定后缀图片插件
  - 发送QQ邮件插件
  - 自动使用浏览器cookies插件
  - 导出收藏夹为csv文件插件
  - 合并所有图片为pdf文件插件
  - 合并所有图片为长图png插件
  - 重复文件检测删除插件
  - 网页观看本地章节插件

#### 8. `jm_toolkit.py` - 工具类
提供各种工具函数：
- `JmcomicText`: 文本解析工具
  - 解析JM ID
  - 解析HTML内容
  - 提取本子/章节信息
- `JmImageTool`: 图片处理工具
  - 图片解密
  - 图片格式转换
  - 图片保存
- `JmCryptoTool`: 加密解密工具
  - API数据加解密

#### 9. `jm_config.py` - 配置管理
全局配置管理：
- `JmModuleConfig`: 模块配置类
  - 注册客户端实现
  - 注册插件
  - 管理异常监听器

#### 10. `cl.py` - 命令行接口
提供命令行使用方式：
- `JmcomicUI`: 命令行UI类
- 支持通过命令行参数指定要下载的本子/章节
- 支持通过环境变量或参数指定配置文件

## 使用方式

### 1. Python API方式

```python
import jmcomic

# 简单下载
jmcomic.download_album('123')

# 使用配置下载
option = jmcomic.create_option_by_file('option.yml')
jmcomic.download_album(123, option)
```

### 2. 命令行方式

```bash
# 下载本子123
jmcomic 123

# 下载本子123和章节456
jmcomic 123 p456

# 使用配置文件
jmcomic 123 --option="D:/option.yml"
```

### 3. GitHub Actions方式

支持通过GitHub Actions在云端自动下载，用户只需在网页上输入本子ID即可。

## 项目特点

### 1. 可配置性强

- **零配置可用**: 不配置也能直接使用
- **配置文件支持**: 支持YAML等多种格式的配置文件
- **配置项丰富**: 
  - 请求域名
  - 客户端实现方式（网页端/移动端）
  - 是否使用磁盘缓存
  - 同时下载的章节/图片数量
  - 图片格式转换
  - 下载路径规则
  - 请求元信息（headers、cookies、proxies）
  - 中文繁/简转换

### 2. 可扩展性强

- **自定义回调函数**: 支持自定义本子/章节/图片下载前后的回调
- **自定义类**: 支持自定义Downloader、Option、Client、实体类等
- **插件系统**: 完善的插件机制，方便扩展功能
- **自定义日志**: 支持自定义日志系统
- **异常监听器**: 支持自定义异常监听器

### 3. 技术优势

- **多客户端支持**: 网页端和移动端两种实现，可根据需要切换
- **反爬虫对抗**: 实现了Cloudflare绕过机制
- **加解密支持**: 完整实现APP端接口加解密
- **高并发下载**: 多线程下载，可细化到一图一线程
- **容错机制**: 自动重试、域名切换等容错机制

## 项目结构

```
JMComic-Crawler-Python/
├── .github/              # GitHub Actions配置文件
├── assets/               # 资源文件
│   ├── docs/            # 项目文档
│   │   ├── sources/     # 文档源文件
│   │   │   ├── api/     # API文档
│   │   │   ├── tutorial/# 教程文档
│   │   │   └── ...
│   │   └── mkdocs.yml   # MkDocs配置
│   └── option/          # 配置文件示例
├── src/                  # 源代码
│   └── jmcomic/         # jmcomic模块
│       ├── __init__.py  # 模块初始化
│       ├── api.py       # API接口
│       ├── cl.py        # 命令行接口
│       ├── jm_client_interface.py    # 客户端接口定义
│       ├── jm_client_impl.py         # 客户端实现
│       ├── jm_config.py              # 配置管理
│       ├── jm_downloader.py         # 下载器
│       ├── jm_entity.py             # 实体类
│       ├── jm_exception.py         # 异常定义
│       ├── jm_option.py            # 配置选项
│       ├── jm_plugin.py             # 插件系统
│       └── jm_toolkit.py           # 工具类
├── tests/                # 测试代码
│   └── test_jmcomic/
├── usage/                # 使用示例
│   ├── workflow_download.py
│   └── workflow_export_favorites.py
├── LICENSE              # 许可证
├── README.md            # 项目说明
├── pyproject.toml      # 项目配置
├── setup.py            # 安装脚本
└── requirements-dev.txt # 开发依赖
```

## 技术栈

### 核心依赖

- **commonx** (>=0.6.38): 通用工具库
- **curl-cffi**: HTTP请求库，支持Cloudflare绕过
- **pillow**: 图片处理库
- **pycryptodome**: 加密解密库
- **pyyaml**: YAML配置文件解析

### 开发工具

- **unittest**: 单元测试框架
- **mkdocs**: 文档生成工具

## 工作流程

### 下载流程

1. **初始化**: 创建JmOption配置对象
2. **构建客户端**: 根据配置创建JmcomicClient（网页端或移动端）
3. **获取本子详情**: 调用`client.get_album_detail()`获取本子信息
4. **遍历章节**: 遍历本子的所有章节
5. **获取章节详情**: 调用`client.get_photo_detail()`获取章节信息
6. **下载图片**: 
   - 遍历章节的所有图片
   - 调用`client.download_image()`下载每张图片
   - 根据scramble_id解密图片
   - 保存到指定路径
7. **执行插件**: 在下载前后执行配置的插件
8. **完成回调**: 执行下载完成后的回调函数

### 数据流

```
用户请求 → API层 → Downloader → Client → 网络请求 → 响应解析 → 实体对象 → 下载处理 → 文件保存
```

## 扩展点

### 1. 自定义客户端

可以继承`JmcomicClient`接口，实现自定义的客户端：
- 自定义请求方式
- 自定义数据处理逻辑
- 自定义加解密方式

### 2. 自定义插件

可以继承`JmOptionPlugin`基类，创建自定义插件：
- 在下载前后执行自定义逻辑
- 处理下载的文件
- 发送通知等

### 3. 自定义下载器

可以继承`JmDownloader`类，自定义下载逻辑：
- 自定义下载流程
- 自定义错误处理
- 自定义进度显示

### 4. 自定义实体类

可以继承实体基类，扩展数据模型：
- 添加自定义字段
- 自定义数据处理逻辑

## 最佳实践

### 1. 配置管理

- 使用YAML配置文件管理配置
- 通过环境变量覆盖配置
- 为不同场景创建不同的配置文件

### 2. 错误处理

- 使用异常监听器捕获和处理异常
- 配置合理的重试次数
- 记录下载失败的资源

### 3. 性能优化

- 根据网络情况调整并发数
- 使用磁盘缓存减少重复请求
- 合理使用多线程下载

### 4. 资源管理

- 不要一次性下载过多内容
- 尊重服务器资源，避免过度请求
- 使用合理的下载间隔

## 注意事项

1. **合法使用**: 请遵守相关法律法规，仅用于个人学习研究
2. **服务器压力**: 不要一次性爬取太多本子，减轻服务器压力
3. **IP限制**: 网页端可能受IP地区限制，移动端兼容性更好
4. **版本兼容**: Python版本建议3.9以上，依赖库可能不支持更低版本
5. **配置更新**: 配置文件格式可能随版本更新而变化，注意查看文档

## 项目维护

- **当前状态**: 项目处于维护阶段，核心功能稳定
- **更新频率**: 根据禁漫API变化和用户需求进行更新
- **问题反馈**: 可通过GitHub Issues反馈问题
- **文档**: 详细文档请参考 https://jmcomic.readthedocs.io

## 总结

JMComic-Crawler-Python是一个功能完善、设计良好的Python爬虫框架。它提供了：

1. **完整的API**: 覆盖了禁漫的主要功能
2. **灵活的配置**: 支持多种配置方式
3. **强大的扩展性**: 插件系统和自定义类支持
4. **良好的用户体验**: 支持命令行、API、GitHub Actions多种使用方式
5. **技术先进性**: 实现了反爬虫对抗、加解密等高级功能

项目适合：
- 需要批量下载禁漫内容的用户
- 想要学习爬虫技术的开发者
- 需要集成禁漫功能的开发者
- 想要扩展功能的开发者

---

*本文档生成时间: 2025年*
*项目版本: v2.6.10*

